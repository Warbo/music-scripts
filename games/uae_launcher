#! /usr/bin/env nix-shell
#! nix-shell -i bash -p bash fs-uae

[[ -n "$DIR" ]] || {
    echo "Please specify \$DIR" >> /dev/stderr
    exit 1
}

BASE="/home/chris/System/Games"

STOP=0
ARGS=( '--kickstart_file=/home/chris/System/Games/Kickstart3.1.rom' )
for F in "$BASE"/"$DIR"/*.adf
do
    [[ "$STOP" -eq 0 ]] || {
        echo "Couldn't determine drive for '$F'" >> /dev/stderr
        exit 1
    }
    if echo "$F" | grep " of " > /dev/null
    then
        FOUND=$(basename "$F" .adf | sed -e 's/.*Disk \(.*\) of .*/\1/g')
        echo "FOUND: $FOUND" >> /dev/stderr
        FOUND=$(( FOUND - 1 ))
        ARGS+=(--floppy_drive_$FOUND="$F")
        ARGS+=(--floppy_image_$FOUND="$F")
    else
        ARGS+=(--floppy_drive_0="$F")
        ARGS+=(--floppy_image_0="$F")
        STOP=1
    fi
done

[[ -n "$MODEL" ]] || MODEL="A1200/020"
[[ -n "$CHIPSET" ]] || CHIPSET="aga"


# -x No X cursor
# -G Don't launch GUI first
# -T Use SHM extension for speed
fs-uae --amiga_model="$MODEL" --uae_chipset="$CHIPSET" -x -G -T "${ARGS[@]}" --initial_input_grab=0 "${EXTRA[@]}"
