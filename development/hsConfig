#! /usr/bin/env nix-shell
#! nix-shell -i bash -p bash cabal2nix

function genDefault {
    DEF=$(cabal2nix ./.) || {
        echo "Error: $DEF" >> /dev/stderr
        exit 1
    }
    echo "$DEF"
}

function genShell {
    cabal2nix --shell ./. || {
        echo "Error generating shell.nix contents" 1>&2
        exit 1
    }
}

function writeFile {
    # Only write to existing files; dump any old content to stdout first
    if [[ -e "$1" ]]
    then
        echo "START $1"
        cat "$1"
        echo "END $1"
        echo "Generating $1"
        cat > "$1"
    fi
}

function haveTests {
    tr '[:upper:]' '[:lower:]' < *.cabal | grep "^\s*test-suite" > /dev/null
}

# Update any existing files
genDefault | writeFile "default.nix"
genShell   | writeFile "shell.nix"

# Coverage can cause instability, so only use it when opted in
if [[ -n "$COVERAGE" ]]
then
    COVERAGEOPT="--enable-coverage"
else
    COVERAGEOPT=""
fi

if haveTests
then
    CMD="cabal configure --enable-tests $COVERAGEOPT --enable-benchmarks -v"
else
    CMD="cabal configure --enable-benchmarks -v"
fi

SHELL=$(genShell)

if [[ -z "$PKGS" ]] && [[ -z "$COMPILER" ]]
then
    echo "Configuring package"
    if [[ -e "shell.nix" ]]
    then
        nix-shell --run "$CMD"
    else
        nix-shell -E "$SHELL" --run "$CMD"
    fi
else
    [[ -n "$PKGS"     ]] || PKGS="(import <nixpkgs> {})"
    [[ -n "$COMPILER" ]] || COMPILER="default"
    export PKGS
    export COMPILER

    ARGS='nixpkgs = getEnv "PKGS"; compiler = getEnv "COMPILER";'
    nix-shell -E "with builtins; ($SHELL) { $ARGS }" --run "$CMD"
fi
