#! /usr/bin/env nix-shell
#! nix-shell -i bash -p bash xidel

[[ -z "$DEBUG" ]] || set -x

BASE=$(dirname "$(readlink "$0")")

function search {
    # Poor man's URL escaping
    echo "$@" | sed -e 's/ /+/g'
}

# Search for commandline arguments and get videos
Q=$(search "$@")
URL="${SITE}/stream/${Q}"

function runCurl {
    curl -s "$URL"
}

function allResults {
    xidel - -q --extract '//div[@class="title"]/a/@href'
}

function removeAds {
    grep -v "^/source/"
}

function prefixLinks {
    while read -r REL
    do
        echo "${SITE}${REL}"
    done
}

function getLinks {
    while read -r URL2
    do
        "$BASE/vidsfrompage" "$URL2"
    done
}

runCurl | allResults | removeAds | prefixLinks | getLinks
