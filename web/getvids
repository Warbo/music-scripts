#! /usr/bin/env nix-shell
#! nix-shell -i bash -p bash xidel jsbeautifier

[[ -z "$DEBUG" ]] || set -x

function search {
    # Poor man's URL escaping
    echo "$@" | sed -e 's/ /+/g'
}

function get {
    # Loop over result links, getting videos and obfuscated javascript
    while read -r LNK
    do
        CONTENT=$(curl -s "$LNK")
        echo "$CONTENT" | getvid
        echo "$CONTENT" | geteval
    done < <(curl -s "$1" |
             xidel - -q --extract '//div[@class="linktitleurl"]/a/@href' |
             grep -v '^/source/')
}

function getvid {
    # Look for video URLs
    INCOMING=$(cat)
    echo "$INCOMING" | getfmt mp4 | findurl
    echo "$INCOMING" | getfmt flv | findurl
}

function findurl {
    # Try to narrow-down output lines to just URLs
    grep -o 'http[^ "<>]*' | grep -o '[^"]*' | grep -v 'ads.ad-center.com'
}

function getfmt {
    # Look for URLs of a particular video format
    INPUT=$(cat)
    while read -r CANDIDATE
    do
        # If we find '"foo.$1"' then use that, otherwise use the whole line
        if ! echo "$CANDIDATE" | grep -io "\"[^\"]*\.${1}[^\"]*\""
        then
            echo "$CANDIDATE"
        fi
    done < <(echo "$INPUT" | grep -i "\.${1}")
}

function geteval {
    # Send any obfuscated javascript through js-beautify, then look for videos
    EVALS=$(grep "eval" | sed -e 's/<[^>]*>//g')
    while read -r LINE
    do
        echo "$LINE" | js-beautify -i | getvid
    done < <(echo "$EVALS")
}

# Search for commandline arguments and get videos
Q=$(search "$@")
URL="${SITE}/stream/${Q}"

function runCurl {
    curl -s "$URL"
}

function allResults {
    xidel - -q --extract '//div[@class="title"]/a/@href'
}

function removeAds {
    grep -v "^/source/"
}

function prefixLinks {
    while read -r REL
    do
        echo "${SITE}${REL}"
    done
}

function getLinks {
    while read -r URL2
    do
        get "$URL2"
    done
}

runCurl | allResults | removeAds | prefixLinks | getLinks
