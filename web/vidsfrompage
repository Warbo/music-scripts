#! /usr/bin/env nix-shell
#! nix-shell -i bash -p xidel -p jsbeautifier -p xvfb_run -p xdotool -p xsel

BASE=$(dirname "$(readlink -f "$0")")

function doXvfb {
  BNAME=$(basename "$BASE")
  if [[ "x$BNAME" = "xweb" ]]
  then
    # We're running from a source checkout
    XD="$(dirname "$BASE")/system"
  else
    # We're running from an installed bin/ directory
    XD="$BASE"
  fi
  "$XD/xvfb-run-safe" "$@"
}

function scrapeWithFirefox {
    if pgrep ".*firefox.*" | grep -v conkeror | grep fox > /dev/null
    then
        echo "Can't scrape pages while Firefox is open, aborting." 1>&2
        exit 1
    fi

    while read -r LINE
    do
        if echo "$LINE" | grep "^http" > /dev/null
        then
            echo "$LINE"
        else
            echo "$LINE" 1>&2
        fi
    done < <(URL="$1" doXvfb "$BASE/ff.sh" | readUrls)
}

function readUrls {
    xidel - -q -e '//iframe/@src'
}

# Loop over result links, getting videos and obfuscated javascript
while read -r LNK
do
    echo "Scraping page '$LNK'" 1>&2
    scrapepage "$LNK"
done < <(scrapeWithFirefox "$1")
