#! /usr/bin/env nix-shell
#! nix-shell -i bash -p bash -p xidel jsbeautifier

function findurl {
    # Try to narrow-down output lines to just URLs
    grep -o 'http[^ "<>]*' | grep -o '[^"]*' | grep -v 'ads.ad-center.com'
}

function getTopUrl {
    PAGE=$(curl -s "$1")
    IFRAME=$(echo "$PAGE" | xidel - -q --extract \
                                  '//div[@class="emd_player"]//iframe/@src')
    echo "$IFRAME" | grep -v '^/source/'
}

# Loop over result links, getting videos and obfuscated javascript
while read -r LNK
do
    scrapepage "$LNK"
done < <(getTopUrl "$1")
