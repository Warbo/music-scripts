#! /usr/bin/env nix-shell
#! nix-shell -p bash -p cabal2nix -i bash

if [[ -e "default.nix" ]]
then
    echo "START DEFAULT.NIX"
    cat default.nix
    echo "END DEFAULT.NIX"
fi
echo "Generating default.nix"
DEF=$(cabal2nix ./.) ||
    { echo "Error: $DEF" >> /dev/stderr; exit 1; }

echo "$DEF" > default.nix

if [[ -e "shell.nix" ]]
then
    echo "START SHELL.NIX"
    cat shell.nix
    echo "END SHELL.NIX"
fi

SHELL=$(cabal2nix --shell .) ||
    { echo "Shell error: $SHELL" >> /dev/stderr; exit 1; }

echo "$SHELL" > shell.nix

echo "Configuring package"
nix-shell --run 'cabal configure --enable-tests --enable-coverage -v'
